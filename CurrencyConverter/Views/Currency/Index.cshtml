@{
    ViewData["Title"] = "Currency Converter";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2 class="text-center">Convert EUR to 3 Currencies (Past 7 Mondays)</h2>

<div class="container text-center mt-4">
    <input type="number" id="amount" placeholder="Amount in EUR" class="form-control mb-2" />
    
    <select id="cur1" class="form-control mb-2">
        <option>USD</option>
        <option>ILS</option>
        <option>CAD</option>
    </select>
    <select id="cur2" class="form-control mb-2">
        <option>USD</option>
        <option>ILS</option>
        <option>CAD</option>
    </select>
    <select id="cur3" class="form-control mb-2">
        <option>USD</option>
        <option>ILS</option>
        <option>CAD</option>
    </select>

    <button class="btn btn-primary" id="convert">Convert</button>
</div>

<div id="error" class="alert alert-danger mt-3 text-center" style="display:none"></div>

<div class="container mt-4" id="result" style="display:none"></div>

@section Scripts {
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $("#convert").click(function () {
        $("#result").hide();
        $("#error").hide();

        const data = {
            amount: $("#amount").val(),
            currencies: [$("#cur1").val(), $("#cur2").val(), $("#cur3").val()]
        };
        $.ajax({
            url: "/Currency/GetRates",
            method: "POST",
            data: JSON.stringify(data),
            contentType: "application/json",
            success: function (res) {
                const html = buildTable(res);
                $("#result").html(html).fadeIn();
            },
            error: function (xhr) {
                $("#error").text(xhr.responseText).slideDown();
            }
        });
    });

    function buildTable(data) {
        const currencies = Object.keys(data[0].converted);
        const max = {};
        const min = {};
        currencies.forEach(c => {
            const values = data.map(d => d.converted[c]);
            max[c] = Math.max(...values);
            min[c] = Math.min(...values);
        });

        let html = `<table class="table table-bordered"><thead class="table-dark"><tr><th>Date</th>`;
        currencies.forEach(c => html += `<th>${c}</th>`);
        html += `</tr></thead><tbody>`;

        data.forEach((row, idx) => {
            html += `<tr class="${idx % 2 === 0 ? 'table-light' : ''}"><td>${row.date.split('T')[0]}</td>`;
            currencies.forEach(c => {
                const val = row.converted[c].toFixed(2);
                const color = val == max[c] ? 'green' : val == min[c] ? 'red' : 'black';
                html += `<td style="color:${color}">${val}</td>`;
            });
            html += `</tr>`;
        });

        html += `</tbody></table>`;
        return html;
    }
</script>
}